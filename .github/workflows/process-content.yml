name: Build Book

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-book:
    runs-on: ubuntu-latest

    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_ISSUER: clerk.matbu.vercel.app
      JWT_AUDIENCE: clerk
      CONTENT_ID: 83be47c8-19ad-4bc2-bc32-6a75ea1d845c
      FORMAT: epub
      BASE_URL: https://matbu.vercel.app

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🛠️ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 🔐 Install JWT dependencies
        run: npm install jsonwebtoken

      - name: 🔑 Generate JWT token
        run: node scripts/generate-jwt.js

      - name: 🧪 Debug JWT token
        run: |
          echo "JWT token:"
          cat jwt-token.txt

      - name: 📚 Fetch and build book
        run: bash scripts/fetch-book.sh
        env:
          JWT_HEADER: "Bearer $(cat jwt-token.txt)"
